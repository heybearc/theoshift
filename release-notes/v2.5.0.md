# Release Notes - Version 2.5.0

**Release Date:** October 30, 2025  
**Type:** Minor Release (New Features + Security Fixes)

---

## ğŸ‰ New Features

### Session Management System
Complete session tracking and management for administrators.

**Features:**
- **Real-time Session Tracking:** Automatic tracking of user logins and activity
- **Session Management Page:** View all active sessions with detailed information
  - User name, email, and role
  - Online/Offline status indicators (ğŸŸ¢ Online / âšª Idle)
  - Last activity timestamp ("Just now", "5m ago", "2h ago")
  - Session expiry information
  - IP address and user agent tracking
- **Admin Dashboard Integration:** Active sessions count card with live updates
- **Activity Monitoring:** Automatic activity updates every 5 minutes
- **Hybrid Architecture:** JWT authentication with database session tracking

**Benefits:**
- See who is currently logged in
- Monitor user activity in real-time
- Track session history
- Better security visibility
- Industry-standard session management

**Access:** Admin Portal â†’ Session Management

---

## ğŸ”’ Security Fixes

### Event Permissions Enforcement
**Critical Fix:** Event select page was showing ALL events to all users, regardless of permissions.

**Issue:**
- Non-admin users could see events they didn't have access to
- Event list was not filtered by `event_permissions` table

**Fix:**
- Implemented proper permission filtering using `getUserEvents()` function
- Admin users see all events (as intended)
- Non-admin users only see events they have explicit permissions for
- Fixed relation name bug in `getUserEvents()` (event â†’ events)

**Impact:**
- Proper security enforcement
- Users only see events they're authorized to access
- Aligns with permission system used throughout the app

---

## ğŸ› Bug Fixes

### getUserEvents Relation Name
**Issue:** Function was using wrong Prisma relation name ('event' instead of 'events')

**Symptom:**
- Non-admin users with valid permissions saw NO events
- Query failed silently, returning empty results

**Fix:**
- Corrected relation name to match Prisma schema
- Non-admin users now see their assigned events properly

---

## ğŸ“Š Database Changes

### New Table: user_activity
Tracks user login sessions and activity for session management.

**Schema:**
- `id` - UUID primary key
- `userId` - Foreign key to users table
- `sessionId` - Unique session identifier
- `loginAt` - Login timestamp
- `lastActivityAt` - Last activity timestamp (updated every 5 min)
- `logoutAt` - Logout timestamp (nullable)
- `ipAddress` - Client IP address
- `userAgent` - Browser/device information
- `isActive` - Session active flag

**Indexes:**
- userId (for user lookup)
- isActive (for active sessions query)
- lastActivityAt (for online status)

**Migration:** Applied automatically during deployment

---

## ğŸ”§ Technical Details

### Session Tracking Implementation
- **Strategy:** Hybrid JWT + Database
- **JWT:** Used for authentication (existing)
- **Database:** Used for session visibility and management (new)
- **Activity Updates:** Every 5 minutes via client-side hook
- **Online Threshold:** 15 minutes since last activity
- **Session Expiry:** 30 days of inactivity

### Files Changed
- `src/hooks/useActivityTracking.ts` - New activity tracking hook
- `pages/api/auth/track-activity.ts` - New activity tracking API
- `pages/api/admin/sessions.ts` - Session management API
- `pages/admin/sessions.tsx` - Session management page
- `pages/admin/index.tsx` - Dashboard integration
- `pages/_app.tsx` - Activity tracking integration
- `pages/events/select.tsx` - Permission filtering fix
- `src/lib/eventAccess.ts` - Relation name fix
- `prisma/schema.prisma` - New user_activity table

---

## âœ… Testing Performed

### Session Management
- [x] Login creates session record
- [x] Activity updates every 5 minutes
- [x] Online/Offline indicators work correctly
- [x] Session Management page displays all data
- [x] Admin dashboard shows correct count
- [x] Multiple concurrent sessions supported
- [x] Logout marks session inactive

### Event Permissions
- [x] Admin sees all events
- [x] Non-admin with permissions sees assigned events
- [x] Non-admin without permissions sees no events
- [x] Permission filtering works correctly

---

## ğŸš€ Deployment Notes

**Deployment Order:**
1. Deploy code to STANDBY
2. Migration applied automatically (user_activity table)
3. Test on STANDBY
4. Switch traffic to PRODUCTION
5. Sync new STANDBY

**Rollback Plan:**
- Code is backward compatible
- New table doesn't affect existing functionality
- Can rollback code without database changes
- Session tracking gracefully handles missing table

---

## ğŸ“ Known Issues

None at this time.

---

## ğŸ¯ Next Steps

**Future Enhancements:**
- Force logout capability (revoke specific sessions)
- Bulk session management
- Session history and audit log
- Multiple device detection alerts
- Session timeout warnings

---

## ğŸ‘¥ Credits

**Developed by:** APEX Guardian System  
**Tested on:** STANDBY (Blue) Environment  
**Approved by:** System Administrator
