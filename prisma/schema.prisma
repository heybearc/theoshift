generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model assignments {
  id              String           @id
  eventId         String
  userId          String
  positionId      String
  shiftId         String?
  shiftStart      DateTime
  shiftEnd        DateTime
  status          AssignmentStatus @default(ASSIGNED)
  notes           String?
  assignedBy      String?
  assignedAt      DateTime         @default(now())
  createdAt       DateTime         @default(now())
  updatedAt       DateTime
  events          events           @relation(fields: [eventId], references: [id], onDelete: Cascade)
  event_positions event_positions  @relation(fields: [positionId], references: [id], onDelete: Cascade)
  users           users            @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model attendants {
  id                            String                           @id
  userId                        String?                          @unique
  firstName                     String
  lastName                      String
  email                         String
  phone                         String?
  availabilityStatus            String?                          @default("AVAILABLE")
  isAvailable                   Boolean                          @default(true)
  notes                         String?
  servingAs                     Json?                            @default("[]")
  skills                        Json?
  preferredDepartments          Json?
  unavailableDates              Json?
  totalAssignments              Int                              @default(0)
  totalHours                    Float                            @default(0)
  createdAt                     DateTime                         @default(now())
  updatedAt                     DateTime
  congregation                  String
  formsOfService                Json                             @default("[]")
  isActive                      Boolean                          @default(true)
  pinHash                       String?
  users                         users?                           @relation(fields: [userId], references: [id], onDelete: Cascade)
  event_attendants              event_attendants[]
  event_keyman_assignments      event_attendants[]               @relation("EventKeymanRelation")
  event_overseer_assignments    event_attendants[]               @relation("EventOverseerRelation")
  position_assignments          position_assignments[]
  keyman_assignments            position_assignments[]           @relation("KeymanRelation")
  overseer_assignments          position_assignments[]           @relation("OverseerRelation")
  position_keyman_assignments   position_oversight_assignments[] @relation("KeymanAssignments")
  position_overseer_assignments position_oversight_assignments[] @relation("OverseerAssignments")
  document_publications         document_publications[]
}

model count_sessions {
  id              String             @id
  eventId         String
  sessionName     String
  countTime       DateTime
  notes           String?
  isActive        Boolean            @default(true)
  status          CountSessionStatus @default(ACTIVE)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime
  createdBy       String?
  uploadedAt      DateTime           @default(now())
  uploadedBy      String?
  events          events             @relation(fields: [eventId], references: [id])
  position_counts position_counts[]

  @@unique([eventId, sessionName])
}

model email_configurations {
  id                 String   @id
  smtpServer         String
  smtpPort           Int
  smtpUser           String
  smtpPassword       String
  fromEmail          String
  fromName           String
  replyToEmail       String?
  inviteTemplate     String?
  assignmentTemplate String?
  reminderTemplate   String?
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime
}

model event_attendants {
  id                    String      @id
  eventId               String
  userId                String?
  role                  UserRole    @default(ATTENDANT)
  isActive              Boolean     @default(true)
  assignedDepartments   Json?
  assignedStationRanges Json?
  createdAt             DateTime    @default(now())
  updatedAt             DateTime
  attendantId           String?
  keymanId              String?
  overseerId            String?
  attendants            attendants? @relation(fields: [attendantId], references: [id], onDelete: Cascade)
  events                events      @relation(fields: [eventId], references: [id], onDelete: Cascade)
  keyman                attendants? @relation("EventKeymanRelation", fields: [keymanId], references: [id])
  overseer              attendants? @relation("EventOverseerRelation", fields: [overseerId], references: [id])
  users                 users?      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@unique([eventId, attendantId])
}

model event_positions {
  id                   String            @id
  eventId              String
  positionNumber       Int
  positionName         String
  description          String?
  department           String?
  isActive             Boolean           @default(true)
  isAllDay             Boolean           @default(false)
  isLeadershipPosition Boolean           @default(false)
  requiresExperience   Boolean           @default(false)
  maxAttendants        Int               @default(1)
  minAttendants        Int               @default(1)
  tags                 Json?
  instructions         String?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime
  assignments          assignments[]
  events               events            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  position_counts      position_counts[]

  @@unique([eventId, positionNumber])
}

model events {
  id                           String                           @id
  name                         String
  description                  String?
  status                       EventStatus                      @default(UPCOMING)
  startDate                    DateTime                         @db.Date
  endDate                      DateTime                         @db.Date
  location                     String?
  venue                        String?
  isActive                     Boolean                          @default(true)
  settings                     Json?
  createdAt                    DateTime                         @default(now())
  updatedAt                    DateTime
  createdBy                    String?
  startTime                    String?
  endTime                      String?
  eventType                    EventType                        @default(CIRCUIT_ASSEMBLY)
  attendantsNeeded             Int?
  capacity                     Int?
  circuitoverseername          String?
  circuitoverseerphone         String?
  circuitoverseeremail         String?
  assemblyoverseername         String?
  assemblyoverseerphone        String?
  assemblyoverseeremail        String?
  attendantoverseername        String?
  attendantoverseerphone       String?
  attendantoverseeremail       String?
  attendantoverseerassistants  Json?                            @default("[]")
  assignments                  assignments[]
  count_sessions               count_sessions[]
  event_attendants             event_attendants[]
  event_positions              event_positions[]
  lanyard_settings             lanyard_settings?
  oversight_assignments        oversight_assignments[]
  position_oversight           position_oversight_assignments[]
  positions                    positions[]
  event_documents              event_documents[]
}

model lanyard_settings {
  id                String     @id
  eventId           String     @unique
  totalLanyards     Int
  availableLanyards Int
  isActive          Boolean    @default(true)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime
  events            events     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  lanyards          lanyards[]
}

model lanyards {
  id               String           @id
  lanyardSettingId String
  badgeNumber      String
  isCheckedOut     Boolean          @default(false)
  checkedOutTo     String?
  checkedOutAt     DateTime?
  checkedInAt      DateTime?
  status           LanyardStatus    @default(AVAILABLE)
  notes            String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime
  lanyard_settings lanyard_settings @relation(fields: [lanyardSettingId], references: [id], onDelete: Cascade)

  @@unique([lanyardSettingId, badgeNumber])
}

model oversight_assignments {
  id             String          @id
  eventId        String
  userId         String
  departmentId   String?
  stationRangeId String?
  oversightLevel OversightLevel
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime
  events         events          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  station_ranges station_ranges? @relation(fields: [stationRangeId], references: [id])
  users          users           @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model position_counts {
  id              String          @id
  countSessionId  String
  positionId      String
  attendeeCount   Int?
  notes           String?
  countedBy       String?
  countedAt       DateTime        @default(now())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  count_sessions  count_sessions  @relation(fields: [countSessionId], references: [id], onDelete: Cascade)
  event_positions event_positions @relation(fields: [positionId], references: [id], onDelete: Cascade)

  @@unique([countSessionId, positionId])
}

model station_ranges {
  id                    String                  @id
  departmentId          String
  name                  String
  startStation          Int
  endStation            Int
  description           String?
  isActive              Boolean                 @default(true)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  oversight_assignments oversight_assignments[]
}

model users {
  id                           String                           @id
  email                        String                           @unique
  firstName                    String
  lastName                     String
  phone                        String?
  isActive                     Boolean                          @default(true)
  role                         UserRole                         @default(ATTENDANT)
  passwordHash                 String?
  inviteToken                  String?                          @unique
  inviteExpiry                 DateTime?
  lastLogin                    DateTime?
  createdAt                    DateTime                         @default(now())
  updatedAt                    DateTime
  createdBy                    String?
  name                         String?
  image                        String?
  emailVerified                DateTime?
  congregation                 String?
  accounts                     Account[]
  sessions                     Session[]
  assignments                  assignments[]
  attendants                   attendants?
  event_attendants             event_attendants[]
  oversight_assignments        oversight_assignments[]
  assigned_positions           position_assignments[]           @relation("AssignedByUser")
  assigned_position_oversight  position_oversight_assignments[] @relation("AssignedByUser")
  created_templates            shift_templates[]                @relation("CreatedByUser")

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              users   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model system_settings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?
}

model positions {
  id             String                           @id @default(uuid())
  eventId        String
  positionNumber Int
  name           String
  description    String?
  area           String?
  sequence       Int
  isActive       Boolean                          @default(true)
  createdAt      DateTime                         @default(now())
  updatedAt      DateTime                         @updatedAt
  assignments    position_assignments[]
  oversight      position_oversight_assignments[]
  shifts         position_shifts[]
  event          events                           @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, positionNumber])
  @@index([eventId, sequence])
  @@index([eventId, isActive])
}

model position_shifts {
  id          String                 @id @default(uuid())
  positionId  String
  isAllDay    Boolean                @default(false)
  createdAt   DateTime               @default(now())
  endTime     String?
  name        String
  sequence    Int
  startTime   String?
  assignments position_assignments[]
  position    positions              @relation(fields: [positionId], references: [id], onDelete: Cascade)

  @@index([positionId])
  @@index([positionId, sequence])
}

model position_assignments {
  id             String           @id @default(uuid())
  positionId     String
  shiftId        String?
  attendantId    String
  role           PositionRole
  overseerId     String?
  keymanId       String?
  assignedAt     DateTime         @default(now())
  assignedBy     String?
  assignedByUser users?           @relation("AssignedByUser", fields: [assignedBy], references: [id])
  attendant      attendants       @relation(fields: [attendantId], references: [id], onDelete: Cascade)
  keyman         attendants?      @relation("KeymanRelation", fields: [keymanId], references: [id])
  overseer       attendants?      @relation("OverseerRelation", fields: [overseerId], references: [id])
  position       positions        @relation(fields: [positionId], references: [id], onDelete: Cascade)
  shift          position_shifts? @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  @@unique([positionId, shiftId, attendantId])
  @@index([positionId, shiftId])
  @@index([attendantId])
  @@index([role])
  @@index([overseerId, keymanId])
}

model shift_templates {
  id               String   @id @default(uuid())
  name             String
  description      String?
  shifts           Json
  isSystemTemplate Boolean  @default(false)
  createdBy        String?
  createdAt        DateTime @default(now())
  creator          users?   @relation("CreatedByUser", fields: [createdBy], references: [id])

  @@index([isSystemTemplate])
}

model position_oversight_assignments {
  id             String      @id @default(dbgenerated("(gen_random_uuid())::text"))
  positionId     String      @map("position_id")
  eventId        String      @map("event_id")
  overseerId     String?     @map("overseer_id")
  keymanId       String?     @map("keyman_id")
  assignedBy     String?     @map("assigned_by")
  createdAt      DateTime?   @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime?   @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  assignedByUser users?      @relation("AssignedByUser", fields: [assignedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  event          events      @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  keyman         attendants? @relation("KeymanAssignments", fields: [keymanId], references: [id], onUpdate: NoAction)
  overseer       attendants? @relation("OverseerAssignments", fields: [overseerId], references: [id], onUpdate: NoAction)
  position       positions   @relation(fields: [positionId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([positionId, eventId])
  @@index([eventId], map: "idx_position_oversight_event")
  @@index([keymanId], map: "idx_position_oversight_keyman")
  @@index([overseerId], map: "idx_position_oversight_overseer")
  @@index([positionId], map: "idx_position_oversight_position")
}

model event_documents {
  id              String                @id @default(cuid())
  eventId         String
  title           String
  description     String?
  fileName        String
  fileUrl         String
  fileType        String
  fileSize        Int
  uploadedBy      String
  uploadedAt      DateTime              @default(now())
  publishedTo     String                @default("none") // 'none', 'all', 'individual'
  publishedCount  Int                   @default(0)
  publishedAt     DateTime?
  isActive        Boolean               @default(true)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  
  // Relations
  events          events                @relation(fields: [eventId], references: [id], onDelete: Cascade)
  publications    document_publications[]
  
  @@index([eventId], map: "idx_event_documents_event")
  @@index([uploadedBy], map: "idx_event_documents_uploader")
}

model document_publications {
  id              String                @id @default(cuid())
  documentId      String
  attendantId     String
  publishedAt     DateTime              @default(now())
  viewedAt        DateTime?
  downloadedAt    DateTime?
  
  // Relations
  document        event_documents       @relation(fields: [documentId], references: [id], onDelete: Cascade)
  attendant       attendants            @relation(fields: [attendantId], references: [id], onDelete: Cascade)
  
  @@unique([documentId, attendantId])
  @@index([documentId], map: "idx_document_publications_document")
  @@index([attendantId], map: "idx_document_publications_attendant")
}

enum AssignmentStatus {
  ASSIGNED
  CONFIRMED
  DECLINED
  COMPLETED
  NO_SHOW
}

enum CountSessionStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum DocumentAccessLevel {
  PUBLIC
  ATTENDANTS_ONLY
  LEADERSHIP_ONLY
  DEPARTMENT_SPECIFIC
  POSITION_SPECIFIC
  ADMIN_ONLY
}

enum DocumentCategory {
  EMERGENCY_INFO
  POSITION_INSTRUCTIONS
  EVENT_DOCUMENTATION
  TRAINING_MATERIALS
  ANNOUNCEMENTS
  FORMS
  REPORTS
  OTHER
}

enum EventStatus {
  UPCOMING
  CURRENT
  COMPLETED
  CANCELLED
  ARCHIVED
}

enum EventType {
  CIRCUIT_ASSEMBLY
  REGIONAL_CONVENTION
  SPECIAL_EVENT
  OTHER
}

enum ExperienceLevel {
  BEGINNER
  INTERMEDIATE
  EXPERIENCED
  EXPERT
}

enum LanyardStatus {
  AVAILABLE
  CHECKED_OUT
  LOST
  DAMAGED
  RETIRED
}

enum OversightLevel {
  OVERSEER
  ASSISTANT_OVERSEER
  DEPARTMENT_HEAD
  STATION_OVERSEER
}

enum UserRole {
  ADMIN
  OVERSEER
  ASSISTANT_OVERSEER
  KEYMAN
  ATTENDANT
}

enum PositionRole {
  OVERSEER
  KEYMAN
  ATTENDANT
}
