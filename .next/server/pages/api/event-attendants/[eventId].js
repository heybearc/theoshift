"use strict";(()=>{var e={};e.id=8798,e.ids=[8798],e.modules={8432:e=>{e.exports=require("bcryptjs")},3227:e=>{e.exports=require("next-auth")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9926:e=>{e.exports=import("zod")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},4418:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{config:()=>l,default:()=>u,routeModule:()=>c});var s=a(1802),n=a(7153),i=a(6249),o=a(5586),d=e([o]);o=(d.then?(await d)():d)[0];let u=(0,i.l)(o,"default"),l=(0,i.l)(o,"config"),c=new s.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/event-attendants/[eventId]",pathname:"/api/event-attendants/[eventId]",bundlePath:"",filename:""},userland:o});r()}catch(e){r(e)}})},2999:(e,t,a)=>{a.r(t),a.d(t,{authOptions:()=>m,default:()=>w});var r=a(3227),s=a.n(r);let n=require("next-auth/providers/credentials");var i=a.n(n),o=a(8438),d=a(8432),u=a.n(d);let l=require("fs");var c=a.n(l);let f=e=>{let t=new Date().toISOString(),a=`[${t}] ${e}
`;try{c().appendFileSync("/tmp/nextauth-debug.log",a)}catch(e){}},m={providers:[i()({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){try{if(f(`Starting authorization for: ${e?.email}`),!e?.email||!e?.password)return f("Missing credentials"),null;f("Looking up user in database...");let t=await o._.users.findUnique({where:{email:e.email}});if(!t)return f(`User not found: ${e.email}`),null;if(!t.passwordHash)return f("User has no password hash"),null;f("Comparing password...");let a=await u().compare(e.password,t.passwordHash);if(f(`Password valid: ${a}`),!a)return f(`Invalid password for: ${e.email}`),null;return f(`Authentication successful for: ${t.email}`),{id:t.id,email:t.email,name:`${t.firstName} ${t.lastName}`,image:t.image||null,role:t.role}}catch(e){return f(`Error during authorization: ${e}`),null}}})],session:{strategy:"jwt"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t.role,e.image=t.image),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role),e)},pages:{signIn:"/auth/signin"}},p=s()(m);async function w(e,t){return f(`Auth request: ${e.method} ${e.url}`),await p(e,t)}},5586:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{default:()=>u});var s=a(3227),n=a(2999),i=a(8438),o=a(9926),d=e([o]);let p=(o=(d.then?(await d)():d)[0]).z.object({userId:o.z.string().min(1,"User ID is required"),role:o.z.string().optional(),notes:o.z.string().optional()}),w=o.z.object({attendants:o.z.array(o.z.object({userId:o.z.string().min(1,"User ID is required"),role:o.z.string().optional(),notes:o.z.string().optional()}))});async function u(e,t){let{id:a}=e.query;if(!a||"string"!=typeof a)return t.status(400).json({error:"Event ID is required"});let r=await (0,s.getServerSession)(e,t,n.authOptions);if(!r||!r.user)return t.status(401).json({error:"Unauthorized"});let o=await i._.users.findUnique({where:{email:r.user.email},select:{id:!0,role:!0}});if(!o||!["ADMIN","OVERSEER"].includes(o.role))return t.status(403).json({error:"Insufficient permissions"});if(!await i._.events.findUnique({where:{id:a}}))return t.status(404).json({error:"Event not found"});try{switch(e.method){case"GET":return await l(e,t,a);case"POST":return await c(e,t,a,o.id);default:return t.setHeader("Allow",["GET","POST"]),t.status(405).json({error:"Method not allowed"})}}catch(e){return console.error("Event Attendants API error:",e),t.status(500).json({error:"Internal server error"})}}async function l(e,t,a){let{page:r="1",limit:s="20",search:n="",role:o="",sortBy:d="createdAt",sortOrder:u="desc"}=e.query,l=parseInt(r),c=parseInt(s),f=(l-1)*c,m={eventId:a};n&&(m.users={OR:[{firstName:{contains:n,mode:"insensitive"}},{lastName:{contains:n,mode:"insensitive"}},{email:{contains:n,mode:"insensitive"}}]}),o&&(m.role=o);let[p,w]=await Promise.all([i._.event_attendant_associations.findMany({where:m,skip:f,take:c,include:{users:{select:{id:!0,firstName:!0,lastName:!0,email:!0,role:!0,createdAt:!0}},events:{select:{id:!0,name:!0}}}}),i._.event_attendant_associations.count({where:m})]),h=await i._.users.findMany({where:{AND:[{NOT:{event_attendant_associations:{some:{eventId:a}}}},{role:{in:["ATTENDANT","KEYMAN","ASSISTANT_OVERSEER","OVERSEER"]}}]},select:{id:!0,firstName:!0,lastName:!0,email:!0,role:!0},orderBy:[{lastName:"asc"},{firstName:"asc"}]}),v=Math.ceil(w/c);return t.status(200).json({success:!0,data:{associations:p,availableUsers:h,pagination:{page:l,limit:c,total:w,pages:v,hasNext:l<v,hasPrev:l>1}}})}async function c(e,t,a,r){return e.body.attendants&&Array.isArray(e.body.attendants)?await m(e,t,a,r):await f(e,t,a,r)}async function f(e,t,a,r){let s=p.safeParse(e.body);if(!s.success)return t.status(400).json({error:"Validation failed",details:s.error.errors});let n=s.data;if(!await i._.users.findUnique({where:{id:n.userId}}))return t.status(404).json({error:"User not found"});if(await i._.event_attendant_associations.findUnique({where:{eventId_userId:{eventId:a,userId:n.userId}}}))return t.status(400).json({error:"User is already associated with this event"});let o=await i._.event_attendant_associations.create({data:{id:crypto.randomUUID(),eventId:a,userId:n.userId,role:n.role,createdAt:new Date,updatedAt:new Date},include:{users:{select:{id:!0,firstName:!0,lastName:!0,email:!0,role:!0}}}});return t.status(201).json({success:!0,data:o,message:"Attendant associated with event successfully"})}async function m(e,t,a,r){let s=w.safeParse(e.body);if(!s.success)return t.status(400).json({error:"Validation failed",details:s.error.errors});let{attendants:n}=s.data,o=n.map(e=>e.userId),d=(await i._.users.findMany({where:{id:{in:o}},select:{id:!0}})).map(e=>e.id),u=o.filter(e=>!d.includes(e));if(u.length>0)return t.status(400).json({error:"Some users not found",details:{missingUserIds:u}});let l=(await i._.event_attendant_associations.findMany({where:{eventId:a,userId:{in:o}},select:{userId:!0}})).map(e=>e.userId),c=n.filter(e=>!l.includes(e.userId));if(0===c.length)return t.status(400).json({error:"All users are already associated with this event"});let f=await i._.event_attendant_associations.createMany({data:c.map(e=>({id:crypto.randomUUID(),eventId:a,userId:e.userId,role:e.role,createdAt:new Date,updatedAt:new Date}))});return t.status(201).json({success:!0,data:{created:f.count,skipped:l.length,total:n.length},message:`Successfully associated ${f.count} attendants with event`})}r()}catch(e){r(e)}})},8438:(e,t,a)=>{a.d(t,{_:()=>s});let r=require("@prisma/client"),s=globalThis.prisma??new r.PrismaClient},7153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,t,a)=>{e.exports=a(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var a=t(t.s=4418);module.exports=a})();