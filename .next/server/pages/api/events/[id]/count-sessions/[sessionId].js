"use strict";(()=>{var e={};e.id=219,e.ids=[219],e.modules={8432:e=>{e.exports=require("bcryptjs")},3227:e=>{e.exports=require("next-auth")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9926:e=>{e.exports=import("zod")},6249:(e,s)=>{Object.defineProperty(s,"l",{enumerable:!0,get:function(){return function e(s,t){return t in s?s[t]:"then"in s&&"function"==typeof s.then?s.then(s=>e(s,t)):"function"==typeof s&&"default"===t?s:void 0}}})},9844:(e,s,t)=>{t.a(e,async(e,n)=>{try{t.r(s),t.d(s,{config:()=>l,default:()=>d,routeModule:()=>c});var r=t(1802),o=t(7153),i=t(6249),a=t(9984),u=e([a]);a=(u.then?(await u)():u)[0];let d=(0,i.l)(a,"default"),l=(0,i.l)(a,"config"),c=new r.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/events/[id]/count-sessions/[sessionId]",pathname:"/api/events/[id]/count-sessions/[sessionId]",bundlePath:"",filename:""},userland:a});n()}catch(e){n(e)}})},3515:(e,s,t)=>{t.r(s),t.d(s,{authOptions:()=>l,default:()=>c});var n=t(3227),r=t.n(n);let o=require("next-auth/providers/credentials");var i=t.n(o),a=t(8438),u=t(8432),d=t.n(u);let l={providers:[i()({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let s=await a._.users.findUnique({where:{email:e.email}});return s&&s.passwordHash&&await d().compare(e.password,s.passwordHash)?{id:s.id,email:s.email,name:`${s.firstName} ${s.lastName}`,role:s.role}:null}})],callbacks:{jwt:async({token:e,user:s})=>(s&&(e.role=s.role),e),session:async({session:e,token:s})=>(s&&(e.user.id=s.sub,e.user.role=s.role),e)},pages:{signIn:"/auth/signin"},session:{strategy:"jwt",maxAge:2592e3},cookies:{sessionToken:{name:"__Secure-next-auth.session-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}}},secret:"staging-nextauth-secret-2024"},c=r()(l)},9984:(e,s,t)=>{t.a(e,async(e,n)=>{try{t.r(s),t.d(s,{default:()=>d});var r=t(3227),o=t(3515),i=t(8438),a=t(9926),u=e([a]);let m=(a=(u.then?(await u)():u)[0]).z.object({sessionName:a.z.string().min(1).max(255).optional(),countTime:a.z.string().refine(e=>!isNaN(Date.parse(e)),"Invalid count time").optional(),notes:a.z.string().optional(),status:a.z.enum(["ACTIVE","COMPLETED","CANCELLED"]).optional()});async function d(e,s){let{id:t,sessionId:n}=e.query;if(!t||"string"!=typeof t||!n||"string"!=typeof n)return s.status(400).json({error:"Event ID and Session ID are required"});let a=await (0,r.getServerSession)(e,s,o.authOptions);if(!a||!a.user)return s.status(401).json({error:"Unauthorized"});let u=await i._.users.findUnique({where:{email:a.user.email},select:{id:!0,role:!0}});if(!u)return s.status(401).json({error:"User not found"});try{switch(e.method){case"GET":return await l(e,s,t,n);case"PUT":if(!["ADMIN","OVERSEER"].includes(u.role))return s.status(403).json({error:"Insufficient permissions"});return await c(e,s,t,n);case"DELETE":if("ADMIN"!==u.role)return s.status(403).json({error:"Insufficient permissions"});return await p(e,s,t,n);default:return s.setHeader("Allow",["GET","PUT","DELETE"]),s.status(405).json({error:"Method not allowed"})}}catch(e){return console.error("Count session API error:",e),s.status(500).json({error:"Internal server error"})}}async function l(e,s,t,n){let r=await i._.count_sessions.findUnique({where:{id:n},include:{position_counts:{include:{event_positions:{select:{id:!0,positionNumber:!0,positionName:!0,department:!0}}},orderBy:{event_positions:{positionNumber:"asc"}}}}});return r?r.eventId!==t?s.status(400).json({error:"Count session does not belong to this event"}):s.status(200).json({success:!0,data:r}):s.status(404).json({error:"Count session not found"})}async function c(e,s,t,n){let r=m.safeParse(e.body);if(!r.success)return s.status(400).json({error:"Validation failed",details:r.error.errors});let o=r.data,a=await i._.count_sessions.findUnique({where:{id:n},select:{eventId:!0}});if(!a)return s.status(404).json({error:"Count session not found"});if(a.eventId!==t)return s.status(400).json({error:"Count session does not belong to this event"});let u=await i._.count_sessions.update({where:{id:n},data:{...o.sessionName&&{sessionName:o.sessionName},...o.countTime&&{countTime:new Date(o.countTime)},...void 0!==o.notes&&{notes:o.notes},...o.status&&{status:o.status},updatedAt:new Date},include:{position_counts:{include:{event_positions:{select:{id:!0,positionNumber:!0,positionName:!0,department:!0}}}}}});return s.status(200).json({success:!0,data:u,message:"Count session updated successfully"})}async function p(e,s,t,n){let r=await i._.count_sessions.findUnique({where:{id:n},select:{eventId:!0}});return r?r.eventId!==t?s.status(400).json({error:"Count session does not belong to this event"}):(await i._.count_sessions.delete({where:{id:n}}),s.status(200).json({success:!0,message:"Count session deleted successfully"})):s.status(404).json({error:"Count session not found"})}n()}catch(e){n(e)}})},8438:(e,s,t)=>{t.d(s,{_:()=>r});let n=require("@prisma/client"),r=globalThis.prisma??new n.PrismaClient},7153:(e,s)=>{var t;Object.defineProperty(s,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,s,t)=>{e.exports=t(145)}};var s=require("../../../../../webpack-api-runtime.js");s.C(e);var t=s(s.s=9844);module.exports=t})();