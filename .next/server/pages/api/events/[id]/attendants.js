"use strict";(()=>{var e={};e.id=8362,e.ids=[8362],e.modules={3524:e=>{e.exports=require("@prisma/client")},8432:e=>{e.exports=require("bcryptjs")},3227:e=>{e.exports=require("next-auth")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},4680:(e,t,a)=>{a.r(t),a.d(t,{config:()=>v,default:()=>p,routeModule:()=>A});var r={};a.r(r),a.d(r,{default:()=>u});var s=a(1802),n=a(7153),i=a(6249),o=a(3227),d=a(3515),c=a(4507);async function u(e,t){try{if(!await (0,o.getServerSession)(e,t,d.authOptions))return t.status(401).json({success:!1,error:"Unauthorized"});let{id:a}=e.query;if(!a||"string"!=typeof a)return t.status(400).json({success:!1,error:"Event ID is required"});let r=await c._.events.findUnique({where:{id:a}});if(!r)return t.status(404).json({success:!1,error:"Event not found"});if("GET"===e.method)return await l(e,t,a,r);if("POST"===e.method)return await m(e,t,a,r);if("PUT"===e.method)return await f(e,t,a,r);return t.status(405).json({success:!1,error:"Method not allowed"})}catch(e){return console.error("Event attendants API error:",e),t.status(500).json({success:!1,error:"Internal server error"})}}async function l(e,t,a,r){try{let s=parseInt(e.query.page)||1,n=parseInt(e.query.limit)||25,i=(s-1)*n,o=await c._.attendants.findMany({skip:i,take:n,orderBy:[{lastName:"asc"},{firstName:"asc"}]}),d=await c._.attendants.count(),u=Math.ceil(d/n);return t.status(200).json({success:!0,data:{attendants:o.map(e=>({id:e.id,firstName:e.firstName,lastName:e.lastName,email:e.email,phone:e.phone,congregation:e.congregation||"",formsOfService:e.formsOfService||[],isActive:!1!==e.isActive,notes:e.notes,userId:e.userId,createdAt:e.createdAt,updatedAt:e.updatedAt})),pagination:{page:s,limit:n,total:d,pages:u},eventId:a,eventName:r.name||"Event"}})}catch(e){return console.error("Get event attendants error:",e),t.status(500).json({success:!1,error:"Failed to fetch attendants"})}}async function m(e,t,r,s){try{let{firstName:s,lastName:n,email:i,phone:o,congregation:d,notes:u,formsOfService:l}=e.body;if(!s||!n||!i)return t.status(400).json({success:!1,error:"First name, last name, and email are required"});let m=[];l&&(Array.isArray(l)?m=l:"string"==typeof l&&(m=l.split(",").map(e=>e.trim())));let f=await c._.attendants.create({data:{id:a(4770).randomUUID(),firstName:s,lastName:n,email:i,phone:o||null,congregation:d||"",notes:u||null,formsOfService:m,isAvailable:!0,isActive:!0,userId:null,createdAt:new Date,updatedAt:new Date}}),p=await c._.event_attendant_associations.create({data:{id:a(4770).randomUUID(),eventId:r,attendantId:f.id,createdAt:new Date,updatedAt:new Date}});return t.status(201).json({success:!0,data:{id:f.id,firstName:f.firstName,lastName:f.lastName,email:f.email,phone:f.phone,isActive:f.isActive,createdAt:f.createdAt,updatedAt:f.updatedAt,associationId:p.id}})}catch(e){return console.error("Create event attendant error:",e),t.status(500).json({success:!1,error:"Failed to create attendant"})}}async function f(e,t,r,s){try{let{attendants:s}=e.body;if(!s||!Array.isArray(s))return t.status(400).json({success:!1,error:"Attendants array is required"});let n=0,i=0,o=[];for(let e=0;e<s.length;e++){let t=s[e];try{let e=await c._.attendants.findFirst({where:{email:t.email}});if(e){let s=[];t.formsOfService&&(Array.isArray(t.formsOfService)?s=t.formsOfService:"string"==typeof t.formsOfService&&(s=t.formsOfService.split(",").map(e=>e.trim()))),await c._.attendants.update({where:{id:e.id},data:{firstName:t.firstName,lastName:t.lastName,phone:t.phone||null,congregation:t.congregation||"",notes:t.notes||null,formsOfService:s,isActive:!1!==t.isActive,updatedAt:new Date}}),await c._.event_attendant_associations.findFirst({where:{eventId:r,attendantId:e.id}})||await c._.event_attendant_associations.create({data:{id:a(4770).randomUUID(),eventId:r,attendantId:e.id,createdAt:new Date,updatedAt:new Date}}),i++}else{let e=[];t.formsOfService&&(Array.isArray(t.formsOfService)?e=t.formsOfService:"string"==typeof t.formsOfService&&(e=t.formsOfService.split(",").map(e=>e.trim())));let s=await c._.attendants.create({data:{id:a(4770).randomUUID(),firstName:t.firstName,lastName:t.lastName,email:t.email,phone:t.phone||null,congregation:t.congregation||"",notes:t.notes||null,formsOfService:e,isAvailable:!1!==t.isActive,isActive:!1!==t.isActive,userId:null,createdAt:new Date,updatedAt:new Date}});await c._.event_attendant_associations.create({data:{id:a(4770).randomUUID(),eventId:r,attendantId:s.id,createdAt:new Date,updatedAt:new Date}}),n++}}catch(a){console.error(`Error processing attendant ${e+1}:`,a),o.push({row:e+1,email:t.email||"Unknown",error:a.message||"Unknown error"})}}return t.status(200).json({success:!0,data:{created:n,updated:i,errors:o}})}catch(e){return console.error("Bulk import event attendants error:",e),t.status(500).json({success:!1,error:"Failed to import attendants"})}}let p=(0,i.l)(r,"default"),v=(0,i.l)(r,"config"),A=new s.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/events/[id]/attendants",pathname:"/api/events/[id]/attendants",bundlePath:"",filename:""},userland:r})},3515:(e,t,a)=>{a.r(t),a.d(t,{authOptions:()=>u,default:()=>l});var r=a(3227),s=a.n(r);let n=require("next-auth/providers/credentials");var i=a.n(n),o=a(4507),d=a(8432),c=a.n(d);let u={providers:[i()({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let t=await o._.users.findUnique({where:{email:e.email}});return t&&t.passwordHash&&await c().compare(e.password,t.passwordHash)?{id:t.id,email:t.email,name:`${t.firstName} ${t.lastName}`,role:t.role}:null}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t.role),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role),e)},pages:{signIn:"/auth/signin"},session:{strategy:"jwt",maxAge:2592e3},cookies:{sessionToken:{name:"__Secure-next-auth.session-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}}},secret:"staging-nextauth-secret-2024"},l=s()(u)},4507:(e,t,a)=>{a.d(t,{_:()=>s});var r=a(3524);let s=globalThis.prisma??new r.PrismaClient},7153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,t,a)=>{e.exports=a(145)}};var t=require("../../../../webpack-api-runtime.js");t.C(e);var a=t(t.s=4680);module.exports=a})();