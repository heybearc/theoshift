"use strict";(()=>{var e={};e.id=6623,e.ids=[6623],e.modules={3524:e=>{e.exports=require("@prisma/client")},8432:e=>{e.exports=require("bcryptjs")},3227:e=>{e.exports=require("next-auth")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},5447:(e,t,r)=>{r.r(t),r.d(t,{config:()=>g,default:()=>p,routeModule:()=>v});var a={};r.r(a),r.d(a,{default:()=>d});var s=r(1802),n=r(7153),i=r(6249),o=r(3227),l=r(3515),c=r(4507);async function d(e,t){try{if(!await (0,o.getServerSession)(e,t,l.authOptions))return t.status(401).json({success:!1,error:"Unauthorized"});let{id:r}=e.query;if(!r||"string"!=typeof r)return t.status(400).json({success:!1,error:"Event ID is required"});let a=await c._.events.findUnique({where:{id:r}});if(!a)return t.status(404).json({success:!1,error:"Event not found"});if("GET"===e.method)return await u(e,t,r,a);if("POST"===e.method)return await m(e,t,r,a);if("PUT"===e.method)return await f(e,t,r,a);return t.status(405).json({success:!1,error:"Method not allowed"})}catch(e){return console.error("Event attendants API error:",e),t.status(500).json({success:!1,error:"Internal server error"})}}async function u(e,t,r,a){try{let e=await c._.attendants.findMany({where:{position_assignments:{some:{position:{eventId:r}}}},include:{position_assignments:{where:{position:{eventId:r}},include:{position:{select:{name:!0}}}}}});return t.status(200).json({success:!0,data:e.map(e=>({id:e.id,firstName:e.firstName,lastName:e.lastName,email:e.email,phone:e.phone,congregation:e.congregation,formsOfService:e.formsOfService,isActive:e.isActive,assignments:e.position_assignments.map(e=>({positionName:e.position.name,role:e.role}))}))})}catch(e){return console.error("Get event attendants error:",e),t.status(500).json({success:!1,error:"Failed to fetch attendants"})}}async function m(e,t,a,s){try{let{firstName:a,lastName:s,email:n,phone:i,congregation:o,notes:l,formsOfService:d}=e.body;if(!a||!s||!n)return t.status(400).json({success:!1,error:"First name, last name, and email are required"});let u=[];d&&(Array.isArray(d)?u=d:"string"==typeof d&&(u=d.split(",").map(e=>e.trim())));let m=await c._.attendants.create({data:{id:r(4770).randomUUID(),firstName:a,lastName:s,email:n,phone:i||null,congregation:o||"",notes:l||null,formsOfService:u,isAvailable:!0,isActive:!0,userId:null,createdAt:new Date,updatedAt:new Date}});return console.log(`âœ… Created attendant ${a} ${s} - available for position assignment`),t.status(201).json({success:!0,data:{id:m.id,firstName:m.firstName,lastName:m.lastName,email:m.email,phone:m.phone,congregation:m.congregation,formsOfService:m.formsOfService,isActive:m.isActive,message:"Attendant created and available for position assignment"}})}catch(e){return console.error("Create event attendant error:",e),t.status(500).json({success:!1,error:"Failed to create attendant"})}}async function f(e,t,a,s){try{let{attendants:a}=e.body;if(!Array.isArray(a)||0===a.length)return t.status(400).json({success:!1,error:"Attendants array is required and must not be empty"});console.log(`ðŸ”„ APEX GUARDIAN: Bulk importing ${a.length} attendants to NEW system`);let s=0,n=0,i=[];for(let e=0;e<a.length;e++)try{let t=a[e];if(!t.firstName||!t.lastName||!t.email){i.push({row:e+1,email:t.email||"Unknown",error:"First name, last name, and email are required"});continue}let o=await c._.attendants.findFirst({where:{email:t.email}});if(o){let e=[];t.formsOfService&&(Array.isArray(t.formsOfService)?e=t.formsOfService:"string"==typeof t.formsOfService&&(e=t.formsOfService.split(",").map(e=>e.trim()))),await c._.attendants.update({where:{id:o.id},data:{firstName:t.firstName,lastName:t.lastName,phone:t.phone||null,congregation:t.congregation||"",notes:t.notes||null,formsOfService:e,isActive:!1!==t.isActive,updatedAt:new Date}}),n++,console.log(`âœ… Updated attendant: ${t.firstName} ${t.lastName}`)}else{let e=[];t.formsOfService&&(Array.isArray(t.formsOfService)?e=t.formsOfService:"string"==typeof t.formsOfService&&(e=t.formsOfService.split(",").map(e=>e.trim()))),await c._.attendants.create({data:{id:r(4770).randomUUID(),firstName:t.firstName,lastName:t.lastName,email:t.email,phone:t.phone||null,congregation:t.congregation||"",notes:t.notes||null,formsOfService:e,isAvailable:!1!==t.isActive,isActive:!1!==t.isActive,userId:null,createdAt:new Date,updatedAt:new Date}}),s++,console.log(`âœ… Created attendant: ${t.firstName} ${t.lastName}`)}}catch(t){console.error(`Error processing attendant ${e+1}:`,t),i.push({row:e+1,email:attendantData.email||"Unknown",error:t.message||"Unknown error"})}return console.log(`ðŸŽ¯ APEX GUARDIAN Import Complete: ${s} created, ${n} updated, ${i.length} errors`),console.log(`ðŸ“ NOTE: Attendants are available for position assignment but won't appear in displays until assigned`),t.status(200).json({success:!0,data:{created:s,updated:n,errors:i,message:`Import complete. ${s+n} attendants are now available for position assignment.`}})}catch(e){return console.error("Bulk import event attendants error:",e),t.status(500).json({success:!1,error:"Failed to import attendants"})}}let p=(0,i.l)(a,"default"),g=(0,i.l)(a,"config"),v=new s.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/events/[id]/attendants/index-new-system",pathname:"/api/events/[id]/attendants/index-new-system",bundlePath:"",filename:""},userland:a})},3515:(e,t,r)=>{r.r(t),r.d(t,{authOptions:()=>d,default:()=>u});var a=r(3227),s=r.n(a);let n=require("next-auth/providers/credentials");var i=r.n(n),o=r(4507),l=r(8432),c=r.n(l);let d={providers:[i()({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let t=await o._.users.findUnique({where:{email:e.email}});return t&&t.passwordHash&&await c().compare(e.password,t.passwordHash)?{id:t.id,email:t.email,name:`${t.firstName} ${t.lastName}`,role:t.role}:null}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t.role),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role),e)},pages:{signIn:"/auth/signin"},session:{strategy:"jwt",maxAge:2592e3},cookies:{sessionToken:{name:"__Secure-next-auth.session-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}}},secret:"staging-nextauth-secret-2024"},u=s()(d)},4507:(e,t,r)=>{r.d(t,{_:()=>s});var a=r(3524);let s=globalThis.prisma??new a.PrismaClient},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=5447);module.exports=r})();