"use strict";(()=>{var e={};e.id=5999,e.ids=[5999],e.modules={8432:e=>{e.exports=require("bcryptjs")},3227:e=>{e.exports=require("next-auth")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},9926:e=>{e.exports=import("zod")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},3183:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{config:()=>u,default:()=>l,routeModule:()=>c});var n=a(1802),s=a(7153),i=a(6249),o=a(508),d=e([o]);o=(d.then?(await d)():d)[0];let l=(0,i.l)(o,"default"),u=(0,i.l)(o,"config"),c=new n.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/attendants",pathname:"/api/attendants",bundlePath:"",filename:""},userland:o});r()}catch(e){r(e)}})},508:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{default:()=>m});var n=a(3227),s=a(2999),i=a(8438),o=a(9926),d=a(4770),l=a.n(d),u=a(999),c=e([o]);let w=(o=(c.then?(await c)():c)[0]).z.object({firstName:o.z.string().min(1,"First name is required"),lastName:o.z.string().min(1,"Last name is required"),email:o.z.string().email("Valid email is required"),phone:o.z.string().optional(),congregation:o.z.string().min(1,"Congregation is required"),formsOfService:o.z.array(o.z.enum(["Elder","Ministerial Servant","Exemplary","Regular Pioneer","Other Department"])),isActive:o.z.boolean().default(!0),notes:o.z.string().optional(),userId:o.z.string().optional()});w.partial();let v=o.z.object({attendants:o.z.array(o.z.object({firstName:o.z.string().min(1),lastName:o.z.string().min(1),email:o.z.string().email(),phone:o.z.string().optional(),congregation:o.z.string().min(1),formsOfService:o.z.string(),isActive:o.z.boolean().default(!0),notes:o.z.string().optional()})),eventId:o.z.string().optional()});async function m(e,t){try{let a=await (0,n.getServerSession)(e,t,s.authOptions);if(!a||!a.user)return t.status(401).json({success:!1,error:"Unauthorized"});let r=await i._.users.findUnique({where:{email:a.user.email},select:{id:!0,role:!0}});if(!r||!["ADMIN","OVERSEER"].includes(r.role))return t.status(403).json({success:!1,error:"Insufficient permissions"});switch(e.method){case"GET":return await p(e,t);case"POST":return await f(e,t);case"PUT":return await g(e,t);default:return t.status(405).json({success:!1,error:"Method not allowed"})}}catch(e){return console.error("Attendants API error:",e),t.status(500).json({success:!1,error:"Internal server error"})}}async function p(e,t){let{page:a="1",limit:r="10",search:n="",congregation:s="",formsOfService:o="",isActive:d="",hasUser:l="",includeStats:u="false",eventId:c=""}=e.query,m=parseInt(a),p=parseInt(r),f=(m-1)*p,g={};if(n&&(g.OR=[{firstName:{contains:n,mode:"insensitive"}},{lastName:{contains:n,mode:"insensitive"}},{email:{contains:n,mode:"insensitive"}},{congregation:{contains:n,mode:"insensitive"}}]),s&&(g.congregation={contains:s,mode:"insensitive"}),o){let e=o.split(",").filter(Boolean);e.length>0&&(g.formsOfService={path:"$[*]",array_contains:e})}""!==d&&(g.isActive="true"===d),""!==l&&("true"===l?g.userId={not:null}:g.userId=null);let w=[];if(c){let e=await i._.event_attendant_associations.findMany({where:{eventId:c,isActive:!0},select:{userId:!0,attendantId:!0}}),t=e.filter(e=>e.userId).map(e=>e.userId),a=e.filter(e=>e.attendantId).map(e=>e.attendantId);if(t.length>0){let e=await i._.attendants.findMany({where:{userId:{in:t}},select:{id:!0}});w.push(...e.map(e=>e.id))}w.push(...a),w.length>0?g.id={in:w}:g.id={in:[]}}try{let e;let[a,r]=await Promise.all([i._.attendants.findMany({where:g,skip:f,take:p,orderBy:[{lastName:"asc"},{firstName:"asc"}],include:{users:{select:{id:!0,email:!0,firstName:!0,lastName:!0,phone:!0,congregation:!0,role:!0,isActive:!0}}}}),i._.attendants.count({where:g})]);return"true"===u&&(e=await h()),t.status(200).json({success:!0,data:{attendants:a,pagination:{page:m,limit:p,total:r,pages:Math.ceil(r/p)},stats:e}})}catch(e){return console.error("Get attendants error:",e),t.status(500).json({success:!1,error:"Failed to fetch attendants"})}}async function f(e,t){try{let a=w.parse(e.body);if(await i._.attendants.findFirst({where:{email:a.email}}))return t.status(400).json({success:!1,error:"Attendant with this email already exists"});if(a.userId&&!await i._.users.findUnique({where:{id:a.userId}}))return t.status(400).json({success:!1,error:"User not found"});let r=await i._.attendants.create({data:{id:l().randomUUID(),firstName:a.firstName,lastName:a.lastName,email:a.email,phone:a.phone,congregation:a.congregation,formsOfService:a.formsOfService,isActive:a.isActive,notes:a.notes,userId:a.userId,updatedAt:new Date},include:{users:{select:{id:!0,email:!0,firstName:!0,lastName:!0,phone:!0,congregation:!0,role:!0,isActive:!0}}}});return t.status(201).json({success:!0,data:r})}catch(e){if(e instanceof o.z.ZodError)return t.status(400).json({success:!1,error:e.errors[0].message});return console.error("Create attendant error:",e),t.status(500).json({success:!1,error:"Failed to create attendant"})}}async function g(e,t){try{let a=v.parse(e.body),r={created:0,updated:0,errors:[]};for(let e=0;e<a.attendants.length;e++){let t=a.attendants[e];try{let e=t.formsOfService.split(",").map(e=>e.trim()).filter(e=>u.G.includes(e)),n=await i._.attendants.findFirst({where:{email:t.email}});if(n?(await i._.attendants.update({where:{id:n.id},data:{firstName:t.firstName,lastName:t.lastName,phone:t.phone,congregation:t.congregation,formsOfService:e,isActive:t.isActive,notes:t.notes,updatedAt:new Date}}),r.updated++):(await i._.attendants.create({data:{id:l().randomUUID(),firstName:t.firstName,lastName:t.lastName,email:t.email,phone:t.phone,congregation:t.congregation,formsOfService:e,isActive:t.isActive,notes:t.notes,updatedAt:new Date}}),r.created++),a.eventId){let e=await i._.attendants.findFirst({where:{email:t.email}});e&&(e.userId?await i._.event_attendant_associations.upsert({where:{eventId_userId:{eventId:a.eventId,userId:e.userId}},create:{id:l().randomUUID(),eventId:a.eventId,userId:e.userId,isActive:!0,updatedAt:new Date},update:{isActive:!0,updatedAt:new Date}}):await i._.event_attendant_associations.upsert({where:{eventId_attendantId:{eventId:a.eventId,attendantId:e.id}},create:{id:l().randomUUID(),eventId:a.eventId,attendantId:e.id,isActive:!0,updatedAt:new Date},update:{isActive:!0,updatedAt:new Date}}))}}catch(a){r.errors.push({row:e+1,email:t.email,error:a instanceof Error?a.message:"Unknown error"})}}return t.status(200).json({success:!0,data:r})}catch(e){if(e instanceof o.z.ZodError)return t.status(400).json({success:!1,error:e.errors[0].message});return console.error("Bulk import error:",e),t.status(500).json({success:!1,error:"Failed to import attendants"})}}async function h(){let[e,t,a,r,n,s,o]=await Promise.all([i._.attendants.count(),i._.attendants.count({where:{isActive:!0}}),i._.attendants.count({where:{isActive:!1}}),i._.attendants.groupBy({by:["congregation"],_count:{congregation:!0}}),i._.attendants.findMany({select:{formsOfService:!0}}),i._.attendants.count({where:{userId:{not:null}}}),i._.attendants.count({where:{userId:null}})]),d=r.reduce((e,t)=>(e[t.congregation]=t._count.congregation,e),{}),l={};return u.G.forEach(e=>{l[e]=0}),n.forEach(e=>{e.formsOfService.forEach(e=>{u.G.includes(e)&&l[e]++})}),{total:e,active:t,inactive:a,byCongregation:d,byFormsOfService:l,withUsers:s,withoutUsers:o}}r()}catch(e){r(e)}})},2999:(e,t,a)=>{a.r(t),a.d(t,{authOptions:()=>p,default:()=>g});var r=a(3227),n=a.n(r);let s=require("next-auth/providers/credentials");var i=a.n(s),o=a(8438),d=a(8432),l=a.n(d);let u=require("fs");var c=a.n(u);let m=e=>{let t=new Date().toISOString(),a=`[${t}] ${e}
`;try{c().appendFileSync("/tmp/nextauth-debug.log",a)}catch(e){}},p={providers:[i()({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){try{if(m(`Starting authorization for: ${e?.email}`),!e?.email||!e?.password)return m("Missing credentials"),null;m("Looking up user in database...");let t=await o._.users.findUnique({where:{email:e.email}});if(!t)return m(`User not found: ${e.email}`),null;if(!t.passwordHash)return m("User has no password hash"),null;m("Comparing password...");let a=await l().compare(e.password,t.passwordHash);if(m(`Password valid: ${a}`),!a)return m(`Invalid password for: ${e.email}`),null;return m(`Authentication successful for: ${t.email}`),{id:t.id,email:t.email,name:`${t.firstName} ${t.lastName}`,image:t.image||null,role:t.role}}catch(e){return m(`Error during authorization: ${e}`),null}}})],session:{strategy:"jwt"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t.role,e.image=t.image),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role),e)},pages:{signIn:"/auth/signin"}},f=n()(p);async function g(e,t){return m(`Auth request: ${e.method} ${e.url}`),await f(e,t)}},8438:(e,t,a)=>{a.d(t,{_:()=>n});let r=require("@prisma/client"),n=globalThis.prisma??new r.PrismaClient},999:(e,t,a)=>{a.d(t,{G:()=>r});let r=["Elder","Ministerial Servant","Exemplary","Regular Pioneer","Other Department"];r.map(e=>({value:e,label:e}))},7153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,t,a)=>{e.exports=a(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var a=t(t.s=3183);module.exports=a})();