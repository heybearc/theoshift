"use strict";(()=>{var e={};e.id=5104,e.ids=[5104],e.modules={8432:e=>{e.exports=require("bcryptjs")},3227:e=>{e.exports=require("next-auth")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,s)=>{Object.defineProperty(s,"l",{enumerable:!0,get:function(){return function e(s,t){return t in s?s[t]:"then"in s&&"function"==typeof s.then?s.then(s=>e(s,t)):"function"==typeof s&&"default"===t?s:void 0}}})},9879:(e,s,t)=>{t.r(s),t.d(s,{config:()=>p,default:()=>d,routeModule:()=>c});var r={};t.r(r),t.d(r,{default:()=>u});var a=t(1802),i=t(7153),o=t(6249),n=t(3227),l=t(2999);let m="http://10.92.3.136:3000";async function u(e,s){if("POST"!==e.method)return s.status(405).json({success:!1,error:"Method not allowed"});let t=await (0,n.getServerSession)(e,s,l.authOptions);if(!t||t.user?.role!=="ADMIN")return s.status(401).json({success:!1,error:"Unauthorized"});let{to:r,subject:a,message:i}=e.body;if(!r||!a||!i)return s.status(400).json({success:!1,error:"Missing required fields: to, subject, message"});if("true"!==process.env.USE_LXC_SMTP)return console.log("EMAIL TEST (SMTP DISABLED):",{to:r,subject:a,message:i}),s.status(200).json({success:!0,message:"Email test completed (SMTP relay disabled)",data:{to:r,subject:a,status:"logged"}});try{let r;await fetch(m+"/api/send",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.body)}),console.log("Email test request received:",{requestData:{...e.body,gmailAppPassword:"***",smtpPassword:"***",password:"***"}});let a=e.body.authType||("smtp.gmail.com"===e.body.smtpHost?"gmail":"smtp"),i=e.body.config||e.body;if("gmail"===a||"smtp.gmail.com"===i.smtpHost){let e=i.gmailEmail||i.username||i.smtpUser,t=i.gmailAppPassword||i.password||i.smtpPassword,r=i.fromEmail||e;if(i.fromName,!e||!t)return s.status(400).json({success:!1,error:"Gmail email and app password are required"});if(!r)return s.status(400).json({success:!1,error:"From email is required"})}else{if(!i.smtpServer||!i.smtpUser||!i.smtpPassword)return s.status(400).json({success:!1,error:"SMTP configuration incomplete"});if(!i.fromEmail)return s.status(400).json({success:!1,error:"From email is required"})}if("gmail"===a||"smtp.gmail.com"===i.smtpHost){let e=i.gmailEmail||i.username||i.smtpUser,s=i.gmailAppPassword||i.password||i.smtpPassword,t=i.fromEmail||e,a=i.fromName||"JW Attendant Scheduler";r={smtpHost:"smtp.gmail.com",smtpPort:587,smtpUser:e,smtpPassword:s,fromEmail:t,fromName:a}}else r={smtpHost:i.smtpServer||i.smtpHost,smtpPort:parseInt(i.smtpPort||"587"),smtpUser:i.smtpUser||i.username,smtpPassword:i.smtpPassword||i.password,fromEmail:i.fromEmail,fromName:i.fromName||"JW Attendant Scheduler"};console.log("Configuring LXC SMTP relay...");let o=await fetch(`${m}/api/config`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!o.ok){let e=await o.json();throw Error(`SMTP relay configuration failed: ${e.error}`)}console.log("SMTP relay configured, sending test email...");let n=await fetch(`${m}/api/test`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({testEmail:t.user.email||i.gmailEmail||i.smtpUser})});if(!n.ok){let e=await n.json();throw Error(`Test email failed: ${e.error}`)}let l=await n.json();return console.log("Test email sent successfully:",l),s.json({success:!0,message:`âœ… Test email sent successfully via LXC SMTP Relay (Container 136)!`,details:{service:"LXC SMTP Relay",container:"136",ip:"10.92.3.136",to:t.user.email||i.gmailEmail||i.smtpUser,timestamp:new Date().toISOString()}})}catch(e){return console.error("Error sending test email:",e),s.status(500).json({success:!1,error:`Failed to send test email via LXC SMTP relay: ${e.message}`})}}let d=(0,o.l)(r,"default"),p=(0,o.l)(r,"config"),c=new a.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/admin/email-config/test",pathname:"/api/admin/email-config/test",bundlePath:"",filename:""},userland:r})},2999:(e,s,t)=>{t.r(s),t.d(s,{authOptions:()=>c,default:()=>g});var r=t(3227),a=t.n(r);let i=require("next-auth/providers/credentials");var o=t.n(i),n=t(8438),l=t(8432),m=t.n(l);let u=require("fs");var d=t.n(u);let p=e=>{let s=new Date().toISOString(),t=`[${s}] ${e}
`;try{d().appendFileSync("/tmp/nextauth-debug.log",t)}catch(e){}},c={providers:[o()({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){try{if(p(`Starting authorization for: ${e?.email}`),!e?.email||!e?.password)return p("Missing credentials"),null;p("Looking up user in database...");let s=await n._.users.findUnique({where:{email:e.email}});if(!s)return p(`User not found: ${e.email}`),null;if(!s.passwordHash)return p("User has no password hash"),null;p("Comparing password...");let t=await m().compare(e.password,s.passwordHash);if(p(`Password valid: ${t}`),!t)return p(`Invalid password for: ${e.email}`),null;return p(`Authentication successful for: ${s.email}`),{id:s.id,email:s.email,name:`${s.firstName} ${s.lastName}`,image:s.image||null,role:s.role}}catch(e){return p(`Error during authorization: ${e}`),null}}})],session:{strategy:"jwt"},callbacks:{jwt:async({token:e,user:s})=>(s&&(e.role=s.role,e.image=s.image),e),session:async({session:e,token:s})=>(s&&(e.user.id=s.sub,e.user.role=s.role),e)},pages:{signIn:"/auth/signin"}},f=a()(c);async function g(e,s){return p(`Auth request: ${e.method} ${e.url}`),await f(e,s)}},8438:(e,s,t)=>{t.d(s,{_:()=>a});let r=require("@prisma/client"),a=globalThis.prisma??new r.PrismaClient},7153:(e,s)=>{var t;Object.defineProperty(s,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,s,t)=>{e.exports=t(145)}};var s=require("../../../../webpack-api-runtime.js");s.C(e);var t=s(s.s=9879);module.exports=t})();