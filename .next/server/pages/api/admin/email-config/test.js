"use strict";(()=>{var e={};e.id=5104,e.ids=[5104],e.modules={8432:e=>{e.exports=require("bcryptjs")},3227:e=>{e.exports=require("next-auth")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,s)=>{Object.defineProperty(s,"l",{enumerable:!0,get:function(){return function e(s,t){return t in s?s[t]:"then"in s&&"function"==typeof s.then?s.then(s=>e(s,t)):"function"==typeof s&&"default"===t?s:void 0}}})},9879:(e,s,t)=>{t.r(s),t.d(s,{config:()=>p,default:()=>d,routeModule:()=>c});var r={};t.r(r),t.d(r,{default:()=>u});var a=t(1802),o=t(7153),i=t(6249),n=t(3227),l=t(3515);let m="http://10.92.3.136:3000";async function u(e,s){if("POST"!==e.method)return s.status(405).json({success:!1,error:"Method not allowed"});let t=await (0,n.getServerSession)(e,s,l.authOptions);if(!t||t.user?.role!=="ADMIN")return s.status(401).json({success:!1,error:"Unauthorized"});let{to:r,subject:a,message:o}=e.body;if(!r||!a||!o)return s.status(400).json({success:!1,error:"Missing required fields: to, subject, message"});if("true"!==process.env.USE_LXC_SMTP)return console.log("EMAIL TEST (SMTP DISABLED):",{to:r,subject:a,message:o}),s.status(200).json({success:!0,message:"Email test completed (SMTP relay disabled)",data:{to:r,subject:a,status:"logged"}});try{let r;await fetch(m+"/api/send",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.body)}),console.log("Email test request received:",{requestData:{...e.body,gmailAppPassword:"***",smtpPassword:"***",password:"***"}});let a=e.body.authType||("smtp.gmail.com"===e.body.smtpHost?"gmail":"smtp"),o=e.body.config||e.body;if("gmail"===a||"smtp.gmail.com"===o.smtpHost){let e=o.gmailEmail||o.username||o.smtpUser,t=o.gmailAppPassword||o.password||o.smtpPassword,r=o.fromEmail||e;if(o.fromName,!e||!t)return s.status(400).json({success:!1,error:"Gmail email and app password are required"});if(!r)return s.status(400).json({success:!1,error:"From email is required"})}else{if(!o.smtpServer||!o.smtpUser||!o.smtpPassword)return s.status(400).json({success:!1,error:"SMTP configuration incomplete"});if(!o.fromEmail)return s.status(400).json({success:!1,error:"From email is required"})}if("gmail"===a||"smtp.gmail.com"===o.smtpHost){let e=o.gmailEmail||o.username||o.smtpUser,s=o.gmailAppPassword||o.password||o.smtpPassword,t=o.fromEmail||e,a=o.fromName||"JW Attendant Scheduler";r={smtpHost:"smtp.gmail.com",smtpPort:587,smtpUser:e,smtpPassword:s,fromEmail:t,fromName:a}}else r={smtpHost:o.smtpServer||o.smtpHost,smtpPort:parseInt(o.smtpPort||"587"),smtpUser:o.smtpUser||o.username,smtpPassword:o.smtpPassword||o.password,fromEmail:o.fromEmail,fromName:o.fromName||"JW Attendant Scheduler"};console.log("Configuring LXC SMTP relay...");let i=await fetch(`${m}/api/config`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!i.ok){let e=await i.json();throw Error(`SMTP relay configuration failed: ${e.error}`)}console.log("SMTP relay configured, sending test email...");let n=await fetch(`${m}/api/test`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({testEmail:t.user.email||o.gmailEmail||o.smtpUser})});if(!n.ok){let e=await n.json();throw Error(`Test email failed: ${e.error}`)}let l=await n.json();return console.log("Test email sent successfully:",l),s.json({success:!0,message:`âœ… Test email sent successfully via LXC SMTP Relay (Container 136)!`,details:{service:"LXC SMTP Relay",container:"136",ip:"10.92.3.136",to:t.user.email||o.gmailEmail||o.smtpUser,timestamp:new Date().toISOString()}})}catch(e){return console.error("Error sending test email:",e),s.status(500).json({success:!1,error:`Failed to send test email via LXC SMTP relay: ${e.message}`})}}let d=(0,i.l)(r,"default"),p=(0,i.l)(r,"config"),c=new a.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/admin/email-config/test",pathname:"/api/admin/email-config/test",bundlePath:"",filename:""},userland:r})},3515:(e,s,t)=>{t.r(s),t.d(s,{authOptions:()=>u,default:()=>d});var r=t(3227),a=t.n(r);let o=require("next-auth/providers/credentials");var i=t.n(o),n=t(8438),l=t(8432),m=t.n(l);let u={providers:[i()({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let s=await n._.users.findUnique({where:{email:e.email}});return s&&s.passwordHash&&await m().compare(e.password,s.passwordHash)?{id:s.id,email:s.email,name:`${s.firstName} ${s.lastName}`,role:s.role}:null}})],callbacks:{jwt:async({token:e,user:s})=>(s&&(e.role=s.role),e),session:async({session:e,token:s})=>(s&&(e.user.id=s.sub,e.user.role=s.role),e)},pages:{signIn:"/auth/signin"},session:{strategy:"jwt",maxAge:2592e3},cookies:{sessionToken:{name:"__Secure-next-auth.session-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}}},secret:"staging-nextauth-secret-2024"},d=a()(u)},8438:(e,s,t)=>{t.d(s,{_:()=>a});let r=require("@prisma/client"),a=globalThis.prisma??new r.PrismaClient},7153:(e,s)=>{var t;Object.defineProperty(s,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,s,t)=>{e.exports=t(145)}};var s=require("../../../../webpack-api-runtime.js");s.C(e);var t=s(s.s=9879);module.exports=t})();