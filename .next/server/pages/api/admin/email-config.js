"use strict";(()=>{var e={};e.id=117,e.ids=[117],e.modules={8432:e=>{e.exports=require("bcryptjs")},3227:e=>{e.exports=require("next-auth")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,s){return s in r?r[s]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,s)):"function"==typeof r&&"default"===s?r:void 0}}})},5362:(e,r,s)=>{s.r(r),s.d(r,{config:()=>c,default:()=>m,routeModule:()=>p});var a={};s.r(a),s.d(a,{default:()=>d});var t=s(1802),i=s(7153),n=s(6249),o=s(3227),u=s(2999),l=s(8438);async function d(e,r){let s=await (0,o.getServerSession)(e,r,u.authOptions);if(!s||s.user?.role!=="ADMIN")return r.status(401).json({success:!1,error:"Unauthorized"});if("GET"===e.method)try{let e=await l._.system_settings.findFirst({where:{key:"email_config"}});if(e)return r.json({success:!0,data:JSON.parse(e.value)});return r.json({success:!0,data:{authType:"gmail",config:{gmailEmail:"",gmailAppPassword:"",smtpServer:"smtp.gmail.com",smtpPort:"587",smtpUser:"",smtpPassword:"",smtpSecure:!0,fromEmail:"",fromName:"JW Attendant Scheduler",replyToEmail:""}}})}catch(e){return console.error("Error fetching email config:",e),r.status(500).json({success:!1,error:"Failed to fetch configuration"})}if("POST"===e.method)try{let{authType:a,config:t}=e.body;if("gmail"===a){if(!t.gmailEmail||!t.gmailAppPassword)return r.status(400).json({success:!1,error:"Gmail email and app password are required"})}else if("smtp"===a&&(!t.smtpServer||!t.smtpUser||!t.smtpPassword))return r.status(400).json({success:!1,error:"SMTP server, username, and password are required"});if(!t.fromEmail||!t.fromName)return r.status(400).json({success:!1,error:"From email and name are required"});return await l._.system_settings.upsert({where:{key:"email_config"},update:{value:JSON.stringify({authType:a,config:t}),updatedBy:s.user.id},create:{key:"email_config",value:JSON.stringify({authType:a,config:t}),createdBy:s.user.id,updatedBy:s.user.id}}),r.json({success:!0,message:"Email configuration saved successfully"})}catch(e){return console.error("Error saving email config:",e),r.status(500).json({success:!1,error:"Failed to save configuration"})}return r.status(405).json({success:!1,error:"Method not allowed"})}let m=(0,n.l)(a,"default"),c=(0,n.l)(a,"config"),p=new t.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/admin/email-config",pathname:"/api/admin/email-config",bundlePath:"",filename:""},userland:a})},2999:(e,r,s)=>{s.r(r),s.d(r,{authOptions:()=>p,default:()=>g});var a=s(3227),t=s.n(a);let i=require("next-auth/providers/credentials");var n=s.n(i),o=s(8438),u=s(8432),l=s.n(u);let d=require("fs");var m=s.n(d);let c=e=>{let r=new Date().toISOString(),s=`[${r}] ${e}
`;try{m().appendFileSync("/tmp/nextauth-debug.log",s)}catch(e){}},p={providers:[n()({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){try{if(c(`Starting authorization for: ${e?.email}`),!e?.email||!e?.password)return c("Missing credentials"),null;c("Looking up user in database...");let r=await o._.users.findUnique({where:{email:e.email}});if(!r)return c(`User not found: ${e.email}`),null;if(!r.passwordHash)return c("User has no password hash"),null;c("Comparing password...");let s=await l().compare(e.password,r.passwordHash);if(c(`Password valid: ${s}`),!s)return c(`Invalid password for: ${e.email}`),null;return c(`Authentication successful for: ${r.email}`),{id:r.id,email:r.email,name:`${r.firstName} ${r.lastName}`,image:r.image||null,role:r.role}}catch(e){return c(`Error during authorization: ${e}`),null}}})],session:{strategy:"jwt"},callbacks:{jwt:async({token:e,user:r})=>(r&&(e.role=r.role,e.image=r.image),e),session:async({session:e,token:r})=>(r&&(e.user.id=r.sub,e.user.role=r.role),e)},pages:{signIn:"/auth/signin"}},f=t()(p);async function g(e,r){return c(`Auth request: ${e.method} ${e.url}`),await f(e,r)}},8438:(e,r,s)=>{s.d(r,{_:()=>t});let a=require("@prisma/client"),t=globalThis.prisma??new a.PrismaClient},7153:(e,r)=>{var s;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return s}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(s||(s={}))},1802:(e,r,s)=>{e.exports=s(145)}};var r=require("../../../webpack-api-runtime.js");r.C(e);var s=r(r.s=5362);module.exports=s})();