(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[199],{9781:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/events/[id]/attendants",function(){return a(3365)}])},3365:function(e,t,a){"use strict";a.r(t),a.d(t,{__N_SSP:function(){return y},default:function(){return w}});var n=a(5893),s=a(7294),r=a(1163),l=a(3299),o=a(9008),i=a.n(o),c=a(1664),d=a.n(c);class u{getBaseUrl(e){return"/api/events/".concat(e,"/attendants")}async getEventAttendants(e,t){var a;let n=new URLSearchParams;(null==t?void 0:t.page)&&n.append("page",t.page.toString()),(null==t?void 0:t.limit)&&n.append("limit",t.limit.toString()),(null==t?void 0:t.search)&&n.append("search",t.search),(null==t?void 0:t.congregation)&&n.append("congregation",t.congregation),(null==t?void 0:null===(a=t.formsOfService)||void 0===a?void 0:a.length)&&n.append("formsOfService",t.formsOfService.join(",")),(null==t?void 0:t.isActive)!==void 0&&n.append("isActive",t.isActive.toString()),(null==t?void 0:t.hasUser)!==void 0&&n.append("hasUser",t.hasUser.toString()),(null==t?void 0:t.includeStats)&&n.append("includeStats","true");let s=await fetch("".concat(this.getBaseUrl(e),"?").concat(n));if(!s.ok)throw Error("Failed to fetch event attendants: ".concat(s.statusText));return s.json()}async getEventAttendant(e,t){let a=await fetch("".concat(this.getBaseUrl(e),"/").concat(t));if(!a.ok)throw Error("Failed to fetch event attendant: ".concat(a.statusText));return a.json()}async createEventAttendant(e,t){let a=await fetch(this.getBaseUrl(e),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!a.ok)throw Error((await a.json()).error||"Failed to create event attendant (".concat(a.status,": ").concat(a.statusText,")"));return a.json()}async updateEventAttendant(e,t,a){let n=await fetch("".concat(this.getBaseUrl(e),"/").concat(t),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!n.ok)throw Error((await n.json()).error||"Failed to update event attendant (".concat(n.status,": ").concat(n.statusText,")"));return n.json()}async deleteEventAttendant(e,t){let a=await fetch("".concat(this.getBaseUrl(e),"/").concat(t),{method:"DELETE"});if(!a.ok)throw Error((await a.json()).error||"Failed to delete event attendant (".concat(a.status,": ").concat(a.statusText,")"));return a.json()}async bulkImportEventAttendants(e,t){let a=await fetch(this.getBaseUrl(e),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!a.ok){let e=await a.json();throw console.error("Bulk import error:",e),Error(e.error||"Failed to import event attendants (".concat(a.status,": ").concat(a.statusText,")"))}return a.json()}async bulkUpdateEventAttendantStatus(e,t,a){let n=t.map(t=>this.updateEventAttendant(e,t,{isActive:a}));try{return await Promise.all(n),{success:!0}}catch(e){throw Error("Failed to bulk update attendant status: ".concat(e instanceof Error?e.message:"Unknown error"))}}async bulkDeleteEventAttendants(e,t){let a=t.map(t=>this.deleteEventAttendant(e,t));try{return await Promise.all(a),{success:!0}}catch(e){throw Error("Failed to bulk delete attendants: ".concat(e instanceof Error?e.message:"Unknown error"))}}}let h=new u;var m=a(5340),g=a(5924),v=a(6923),p=a(664),x=a(7497),f=a(4685);function E(e){let{eventId:t,eventName:a}=e;(0,r.useRouter)();let{data:o}=(0,l.useSession)(),{attendants:c,loading:u,error:E,pagination:A,stats:y,filters:w,eventInfo:j,setFilters:N,setPage:b,setPageSize:S,refresh:k,createAttendant:C,updateAttendant:P,deleteAttendant:U,bulkUpdateStatus:I,bulkDelete:D,bulkImport:R}=function(e){let{eventId:t,pageSize:a=10,includeStats:n=!1,initialFilters:r={}}=e,[l,o]=(0,s.useState)([]),[i,c]=(0,s.useState)(!1),[d,u]=(0,s.useState)(null),[m,g]=(0,s.useState)(null),[v,p]=(0,s.useState)({eventId:t,eventName:void 0}),[x,f]=(0,s.useState)(r),[E,A]=(0,s.useState)({page:1,limit:a,total:0,pages:0}),y=(0,s.useCallback)(async()=>{if(!t){console.error("No eventId provided to useEventAttendants");return}try{var e,a;console.log("APEX GUARDIAN: fetchEventAttendants called with:"),console.log("- eventId:",t),console.log("- pagination:",E),console.log("- filters:",x),c(!0),u(null);let s=await h.getEventAttendants(t,{...x,page:E.page,limit:E.limit,includeStats:n});console.log("APEX GUARDIAN: API response:",s),console.log("APEX GUARDIAN: Attendants returned:",(null===(a=s.data)||void 0===a?void 0:null===(e=a.attendants)||void 0===e?void 0:e.length)||0),s.success?(o(s.data.attendants),A(s.data.pagination),p({eventId:s.data.eventId||t,eventName:s.data.eventName}),s.data.stats&&g(s.data.stats)):u(s.error||"Failed to fetch event attendants")}catch(t){let e=t instanceof Error?t.message:"An error occurred";console.error("APEX GUARDIAN: fetchEventAttendants error:",e),u(e)}finally{c(!1)}},[t,x,E.page,E.limit,n]),w=(0,s.useCallback)(e=>{console.log("APEX GUARDIAN: Setting page to:",e),A(t=>{let a={...t,page:e};return console.log("APEX GUARDIAN: New pagination state:",a),a})},[]),j=(0,s.useCallback)(e=>{console.log("APEX GUARDIAN: Setting page size to:",e),A(t=>{let a={...t,limit:-1===e?999999:e,page:1};return console.log("APEX GUARDIAN: New pagination state:",a),a})},[]),N=(0,s.useCallback)(async()=>{await y()},[y]),b=(0,s.useCallback)(async e=>{try{u(null);let a=await h.createEventAttendant(t,e);if(a.success)await N();else throw Error(a.error||"Failed to create attendant")}catch(t){let e=t instanceof Error?t.message:"Failed to create attendant";throw u(e),Error(e)}},[t,N]),S=(0,s.useCallback)(async(e,a)=>{try{u(null);let n=await h.updateEventAttendant(t,e,a);if(n.success)await N();else throw Error(n.error||"Failed to update attendant")}catch(t){let e=t instanceof Error?t.message:"Failed to update attendant";throw u(e),Error(e)}},[t,N]),k=(0,s.useCallback)(async e=>{try{if(u(null),(await h.deleteEventAttendant(t,e)).success)await N();else throw Error("Failed to delete attendant")}catch(t){let e=t instanceof Error?t.message:"Failed to delete attendant";throw u(e),Error(e)}},[t,N]),C=(0,s.useCallback)(async(e,a)=>{try{u(null),await h.bulkUpdateEventAttendantStatus(t,e,a),await N()}catch(t){let e=t instanceof Error?t.message:"Failed to bulk update status";throw u(e),Error(e)}},[t,N]),P=(0,s.useCallback)(async e=>{try{u(null),await h.bulkDeleteEventAttendants(t,e),await N()}catch(t){let e=t instanceof Error?t.message:"Failed to bulk delete";throw u(e),Error(e)}},[t,N]),U=(0,s.useCallback)(async e=>{try{if(u(null),(await h.bulkImportEventAttendants(t,e)).success)await N();else throw Error("Failed to import attendants")}catch(t){let e=t instanceof Error?t.message:"Failed to import attendants";throw u(e),Error(e)}},[t,N]);return(0,s.useEffect)(()=>{t&&y()},[y]),{attendants:l,loading:i,error:d,pagination:E,stats:m,filters:x,eventInfo:v,setFilters:f,setPage:w,setPageSize:j,refresh:N,createAttendant:b,updateAttendant:S,deleteAttendant:k,bulkUpdateStatus:C,bulkDelete:P,bulkImport:U}}({eventId:t,pageSize:25,includeStats:!0});(0,s.useEffect)(()=>{z(Array.from(new Set(c.map(e=>e.congregation).filter(Boolean))).sort())},[c]);let[F,z]=(0,s.useState)([]),[T,X]=(0,s.useState)([]),[G,Z]=(0,s.useState)(!1),[_,B]=(0,s.useState)(!1),[O,L]=(0,s.useState)(null),J=(null==o?void 0:o.user)&&["ADMIN","OVERSEER"].includes(o.user.role),M=()=>{Z(!1),L(null)},W=async e=>{try{O?await P(O.id,e):await C(e),M()}catch(e){console.error("Error saving attendant:",e)}},V=async e=>{if(confirm("Are you sure you want to delete this attendant?"))try{await U(e)}catch(e){console.error("Error deleting attendant:",e)}},Y=async(e,t)=>{try{await I(e,t),X([])}catch(e){console.error("Error updating attendant status:",e)}},q=async e=>{if(confirm("Are you sure you want to delete ".concat(e.length," attendant(s)?")))try{await D(e),X([])}catch(e){console.error("Error deleting attendants:",e)}},H=async e=>{try{await R(e),B(!1)}catch(e){console.error("Error importing attendants:",e)}};return J?(0,n.jsxs)("div",{className:"space-y-6",children:[(0,n.jsx)(i(),{children:(0,n.jsxs)("title",{children:[j.eventName||a||"Event"," - Attendants | JW Attendant Scheduler"]})}),(0,n.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"Event Attendants"}),(0,n.jsxs)("p",{className:"text-gray-600",children:["Manage attendants for ",j.eventName||a||"this event"]})]}),(0,n.jsxs)("div",{className:"flex items-center gap-3",children:[(0,n.jsx)(d(),{href:"/events/".concat(t),className:"text-blue-600 hover:text-blue-800 text-sm font-medium",children:"â† Back to Event"}),(0,n.jsx)(f.Z,{onClick:()=>B(!0),variant:"secondary",size:"sm",children:"Bulk Import"}),(0,n.jsx)(f.Z,{onClick:()=>{L(null),Z(!0)},variant:"primary",size:"sm",children:"Add Attendant"})]})]}),y&&(0,n.jsx)(x.Z,{stats:y,loading:u}),(0,n.jsx)(m.Z,{filters:w,onFiltersChange:N,congregations:F,loading:u}),E&&(0,n.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-md p-4",children:(0,n.jsxs)("div",{className:"flex",children:[(0,n.jsx)("div",{className:"flex-shrink-0",children:(0,n.jsx)("svg",{className:"h-5 w-5 text-red-400",viewBox:"0 0 20 20",fill:"currentColor",children:(0,n.jsx)("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})})}),(0,n.jsxs)("div",{className:"ml-3",children:[(0,n.jsx)("h3",{className:"text-sm font-medium text-red-800",children:"Error"}),(0,n.jsx)("div",{className:"mt-2 text-sm text-red-700",children:(0,n.jsx)("p",{children:E})})]})]})}),T.length>0&&(0,n.jsx)("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsx)("div",{className:"flex items-center",children:(0,n.jsxs)("span",{className:"text-sm font-medium text-blue-900",children:[T.length," attendant(s) selected"]})}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)(f.Z,{onClick:()=>X([]),variant:"secondary",size:"sm",children:"Clear Selection"}),(0,n.jsx)(f.Z,{onClick:()=>Y(T,!0),variant:"success",size:"sm",children:"Activate Selected"}),(0,n.jsx)(f.Z,{onClick:()=>Y(T,!1),variant:"secondary",size:"sm",children:"Deactivate Selected"}),(0,n.jsx)(f.Z,{onClick:()=>q(T),variant:"danger",size:"sm",children:"Delete Selected"})]})]})}),(0,n.jsx)("div",{className:"bg-white shadow rounded-lg",children:(0,n.jsx)(g.Z,{attendants:c,loading:u,onEdit:e=>{L(e),Z(!0)},onDelete:V,onSelect:X,selectedIds:T,onBulkStatusChange:Y})}),(0,n.jsxs)("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 py-4 bg-white rounded-lg shadow px-4",children:[(0,n.jsxs)("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-4",children:[(0,n.jsxs)("div",{className:"text-sm text-gray-700",children:["Showing ",(A.page-1)*A.limit+1," to"," ",Math.min(A.page*A.limit,A.total)," of"," ",A.total," results"]}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("label",{htmlFor:"pageSize",className:"text-sm text-gray-700",children:"Show:"}),(0,n.jsxs)("select",{id:"pageSize",value:999999===A.limit?-1:A.limit,onChange:e=>{console.log("APEX GUARDIAN: Select changed, setPageSize function:",typeof S),console.log("APEX GUARDIAN: New value:",e.target.value),e.preventDefault(),S(Number(e.target.value))},disabled:u,className:"border border-gray-300 rounded-md px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[(0,n.jsx)("option",{value:10,children:"10"}),(0,n.jsx)("option",{value:25,children:"25"}),(0,n.jsx)("option",{value:50,children:"50"}),(0,n.jsx)("option",{value:100,children:"100"}),(0,n.jsx)("option",{value:-1,children:"All"})]}),(0,n.jsx)("span",{className:"text-sm text-gray-700",children:"per page"})]}),(0,n.jsx)(f.Z,{onClick:()=>{console.log("APEX GUARDIAN: Test button clicked!"),console.log("setPageSize type:",typeof S),console.log("Current pagination:",A),S(50)},variant:"primary",size:"sm",type:"button",children:"Test Button (Set to 50)"})]}),A.pages>1&&(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)(f.Z,{onClick:()=>{console.log("APEX GUARDIAN: Previous button clicked, setPage function:",typeof b),console.log("APEX GUARDIAN: Current pagination:",A),b(A.page-1)},disabled:A.page<=1||u,variant:"secondary",size:"sm",type:"button",children:"Previous"}),(0,n.jsxs)("span",{className:"px-3 py-1 text-sm text-gray-700",children:["Page ",A.page," of ",A.pages]}),(0,n.jsx)(f.Z,{onClick:()=>{console.log("APEX GUARDIAN: Next button clicked, setPage function:",typeof b),console.log("APEX GUARDIAN: Current pagination:",A),b(A.page+1)},disabled:A.page>=A.pages||u,variant:"secondary",size:"sm",type:"button",children:"Next"})]})]}),(0,n.jsx)(v.Z,{isOpen:G,onClose:M,onSave:W,attendant:O}),(0,n.jsx)(p.Z,{isOpen:_,onClose:()=>B(!1),onImport:H})]}):(0,n.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Access Denied"}),(0,n.jsx)("p",{className:"text-gray-600 mb-4",children:"You don't have permission to manage attendants."}),(0,n.jsx)(d(),{href:"/events",className:"text-blue-600 hover:text-blue-800",children:"Return to Events"})]})})}var A=a(5083),y=!0;function w(e){let{eventId:t,event:a}=e;return(0,n.jsx)(A.Z,{title:"".concat((null==a?void 0:a.name)||"Event"," - Attendants | JW Attendant Scheduler"),breadcrumbs:[{label:"Events",href:"/events"},{label:(null==a?void 0:a.name)||"Event",href:"/events/".concat(t)},{label:"Attendants"}],selectedEvent:{id:t,name:(null==a?void 0:a.name)||"Event",status:null==a?void 0:a.status},children:(0,n.jsx)(E,{eventId:t,eventName:null==a?void 0:a.name})})}}},function(e){e.O(0,[424,860,888,774,179],function(){return e(e.s=9781)}),_N_E=e.O()}]);