# v2.2.1 Technical Deployment Details

**INTERNAL DOCUMENTATION - NOT FOR PUBLIC RELEASE NOTES**

---

## ðŸ”§ Technical Changes

### Database Schema Fixes
All Prisma includes updated to use correct relationship name:

```typescript
// Before (incorrect)
include: { position: true }

// After (correct)
include: { positions: true }
```

### Files Modified
- `pages/api/events/[id]/assignments/[assignmentId].ts`
- `pages/api/events/[id]/assignments.ts`
- `pages/api/attendant/dashboard.ts`
- `pages/api/health.ts` (NEW)

### Health Check Endpoint
New endpoint: `/api/health`

**Response Format:**
```json
{
  "status": "healthy",
  "timestamp": "2025-10-27T15:00:00.000Z",
  "app": "Theocratic Shift Scheduler",
  "version": "2.2.1",
  "database": {
    "connected": true,
    "users": 45,
    "events": 12
  },
  "uptime": 3600
}
```

**Purpose:**
- MCP server orchestration compatibility
- System health monitoring
- Database connectivity checks

---

## ðŸ“¦ Deployment Details

### Blue-Green Deployment Process

**Environment Details:**
- **Blue (Production):** 10.92.3.22:3001 (Container 132 (green-theoshift)/133)
- **Green (Standby):** 10.92.3.24:3001 (Container 134 (blue-theoshift)/135)
- **Database:** 10.92.3.21:5432 (Container 131)

**Deployment Steps:**
1. Deploy to Blue environment for testing
2. Validate functionality on Blue
3. Switch traffic from Green to Blue via HAProxy
4. Deploy same code to Green
5. Validate Green environment
6. Ready for rollback if needed

### Deployment Commands

**For Blue-Green:**
```bash
# Deploy to Blue
ssh root@10.92.3.22
cd /opt/theoshift
git pull origin production-gold-standard
npm install
npx prisma generate
pm2 stop theoshift-blue
rm -rf .next
npm run build
pm2 start theoshift-blue

# Switch traffic (via MCP or HAProxy)
# ... traffic switch commands ...

# Deploy to Green
ssh root@10.92.3.24
cd /opt/theoshift
git pull origin production-gold-standard
npm install
npx prisma generate
pm2 stop theoshift-green
rm -rf .next
npm run build
pm2 start theoshift-green
```

---

## âœ… Validation Checklist

### Functional Tests
- [ ] Remove attendant functionality working
- [ ] Add attendant functionality working
- [ ] Health endpoint responding correctly (`/api/health`)
- [ ] Dashboard loading attendant data
- [ ] No TypeScript compilation errors
- [ ] Build successful on target environment

### Integration Tests
- [ ] Database connectivity verified
- [ ] API endpoints responding
- [ ] Authentication working
- [ ] Session management functional

### Performance Tests
- [ ] Page load times acceptable
- [ ] API response times < 200ms
- [ ] No memory leaks
- [ ] PM2 process stable

---

## ðŸ› Known Issues

### Technical Limitations
- **Scroll Position Reset:** SSR limitation causes scroll position to reset after page actions
  - **Workaround:** Planned fix in v2.3.0 with client-side state management
  - **Impact:** UX annoyance, not a blocker

---

## ðŸ”„ Rollback Procedure

If issues are detected:

1. **Immediate:** Switch traffic back to previous environment via HAProxy
2. **Verify:** Confirm previous environment is healthy
3. **Investigate:** Check logs for root cause
4. **Fix:** Address issues in development
5. **Redeploy:** Follow standard deployment process

**Rollback Commands:**
```bash
# Via MCP server
mcp3_switch_traffic --app theoshift-green --emergency true

# Or manual HAProxy
ssh root@10.92.3.26
# ... HAProxy commands ...
```

---

## ðŸ“Š Monitoring

### Health Checks
- **Endpoint:** `http://[IP]:3001/api/health`
- **Expected Response:** 200 OK with JSON payload
- **Check Frequency:** Every 30 seconds

### PM2 Monitoring
```bash
pm2 status
pm2 logs theoshift-green-[blue|green]
pm2 monit
```

### Database Monitoring
```bash
ssh root@10.92.3.21
# Check PostgreSQL status
systemctl status postgresql
# Check connections
psql -U postgres -c "SELECT count(*) FROM pg_stat_activity;"
```

---

## ðŸ” Security Notes

- No security vulnerabilities introduced
- All API endpoints require authentication
- Health endpoint provides minimal information
- No sensitive data exposed in responses

---

## ðŸ“ Migration Notes

### Database Migrations
**None required** - Schema changes were internal relationship naming only

### Environment Variables
**No changes** - All existing environment variables remain the same

### Dependencies
**New packages:**
- None (only internal code changes)

---

## ðŸ‘¥ Team Communication

### Stakeholders Notified
- [x] Development team
- [x] Operations team
- [ ] End users (via public release notes)

### Communication Channels
- GitHub commit messages
- Internal deployment docs (this file)
- Public release notes (user-facing)

---

## ðŸ“š Related Documentation

- **Public Release Notes:** `/release-notes/v2.2.1.md`
- **GitHub Commits:** See git log for detailed changes
- **API Documentation:** `/docs/api/` (if exists)
- **Architecture Docs:** `/docs/technical/` (if exists)

---

**Last Updated:** 2025-10-27  
**Deployed By:** Cascade AI + Cory  
**Status:** âœ… Successfully Deployed
